<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ brand }} ‚Äì Assistant {{ (cfg.prompt_profile or 'm√©tier')|capitalize }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* Th√®me pastel ‚ÄúBetty‚Äù (local √† la page) */
    :root{
      --bb-bg: #ffeef6;         /* fond rose tr√®s clair */
      --bb-card: #ffffff;       /* cartes blanches */
      --bb-accent: {{ cfg.accent or '#ff5fa0' }}; /* accent (bouton/bulle) */
      --bb-accent-soft: color-mix(in srgb, {{ cfg.accent or '#ff5fa0' }} 25%, #fff);
      --bb-text: #3a2a35;       /* texte principal */
      --bb-muted: #876b7a;      /* texte secondaire */
    }
    body { background: var(--bb-bg); color: var(--bb-text); }
    .betty-wrap{ max-width: 980px; margin: 28px auto 40px; padding: 0 16px; }
    .betty-top{ text-align:center; margin-bottom: 16px; }
    .betty-top .logo{ width: 64px; height: 64px; margin: 0 auto 12px; border-radius: 50%; overflow:hidden; }
    .betty-top .logo img{ width:100%; height:100%; object-fit:cover; }
    .hello{
      display:inline-block; padding:16px 20px; border-radius:18px;
      background: var(--bb-accent-soft); color: var(--bb-text);
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      max-width: 880px;
    }
    .hello b{ color:#2b1924 }
    .betty-chat{ background: var(--bb-card); border-radius:24px; padding:22px;
      margin: 22px auto 12px; max-width: 900px;
      box-shadow: 0 18px 50px rgba(0,0,0,.08);
    }
    #messages{ height:min(48vh,480px); min-height:200px; overflow:auto; padding:10px 6px; display:flex; flex-direction:column; gap:12px; }
    .bubble{ max-width:72%; padding:12px 14px; border-radius:16px; line-height:1.4; font-size:16px; }
    .bubble.bot{ align-self:flex-start; background:#fff3fa; border:1px solid #ffd3e9; }
    .bubble.user{ align-self:flex-end; background:#edf1ff; border:1px solid #cfd7ff; }
    .betty-row{ display:flex; gap:10px; margin-top:12px; }
    .betty-row input{ flex:1; font-size:16px; padding:14px 16px; border-radius:14px; border:1px solid #e6d8e1; background:#fff; outline:none; }
    .betty-row button{ font-size:16px; padding:14px 18px; border-radius:14px; border:0; background: var(--bb-accent); color:#fff; cursor:pointer; }
    .betty-row button:hover{ filter:brightness(.98); }
    .recap{ background:#fff; border:1px solid #f3dbe7; border-radius:18px; padding:14px 16px; max-width:900px; margin: 16px auto 4px; }
    .recap h3{ margin:0 0 8px; font-size:16px; color:#432b38 }
    .recap ul{ margin:0; padding-left:18px; color:var(--bb-muted) }
    .tiny{ color: var(--bb-muted); text-align:center; margin-top:12px; font-size:13px; }
  </style>
</head>
<body>
  <div class="betty-wrap">
    <div class="betty-top">
      {% if cfg.avatar_url %}
        <div class="logo"><img src="{{ cfg.avatar_url }}" alt="Avatar"></div>
      {% endif %}
      <div class="hello">
        <div><b>Bonjour ! Je suis Betty</b>, l‚Äôassistante {{ (cfg.prompt_profile or 'm√©tier') }}{% if cfg.company %} de {{ cfg.company }}{% endif %}.</div>
        <div>Que puis-je faire pour vous ?</div>
      </div>
    </div>

    <!-- R√©cap clair de la commande -->
    <div class="recap">
      <h3>R√©capitulatif</h3>
      <ul>
        <li><strong>M√©tier :</strong> {{ (cfg.prompt_profile or '‚Äî')|capitalize }}</li>
        <li><strong>Personnalit√© :</strong> {% if cfg.prompt_custom %}{{ cfg.prompt_custom }}{% else %}‚Äî{% endif %}</li>
        <li><strong>Avatar :</strong> {% if cfg.avatar_url %}d√©fini{% else %}non d√©fini{% endif %}</li>
      </ul>
    </div>

    <div class="betty-chat">
      <div id="messages">
        <!-- messages init en fonction du m√©tier -->
        <div class="bubble bot">{{ cfg.welcome or 'Bonjour !' }}</div>
        {% set m = (cfg.prompt_profile or '') %}
        {% if m == 'danse' %}
          <div class="bubble bot">Souhaitez-vous un essai ? Dites-moi votre style et vos disponibilit√©s üíÉ</div>
        {% elif m == 'immobilier' %}
          <div class="bubble bot">Quel type de bien, secteur et budget vous int√©ressent üè° ?</div>
        {% elif m == 'mecanique' %}
          <div class="bubble bot">Mod√®le/ann√©e du v√©hicule et sympt√¥me constat√© üîß ?</div>
        {% elif m == 'nutrition' %}
          <div class="bubble bot">Quel est votre objectif et vos pr√©f√©rences alimentaires ü•ó ?</div>
        {% elif m == 'avocat' %}
          <div class="bubble bot">Pr√©cisez votre demande (sans informations sensibles). Je peux vous proposer un RDV ‚öñÔ∏è.</div>
        {% endif %}
      </div>

      <div class="betty-row">
        <input id="msg" placeholder="√âcrivez votre message ici‚Ä¶" />
        <button id="send">Envoyer</button>
      </div>
    </div>

    <div class="tiny">Client : {{ cfg.full_name }} ‚Äî {{ cfg.email }} ‚Äî ID : {{ tenant_id }}</div>
  </div>

  <script>
    const tenantId = {{ tenant_id|tojson }};
    const sendBtn  = document.getElementById('send');
    const input    = document.getElementById('msg');
    const messages = document.getElementById('messages');

    function addBubble(text, who){
      const div = document.createElement('div');
      div.className = 'bubble ' + who;
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function sendMessage(){
      const text = input.value.trim();
      if(!text) return;
      addBubble(text, 'user');
      input.value = '';
      try {
        const res = await fetch(`/api/chat/${tenantId}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:text})
        });
        const data = await res.json();
        addBubble(data.reply || '[‚Ä¶]', 'bot');
      } catch(e){
        addBubble("D√©sol√©, une erreur r√©seau est survenue.", "bot");
        console.error(e);
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });
  </script>
</body>
</html>
