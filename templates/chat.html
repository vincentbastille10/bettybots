<!doctype html><html><body><h1>Chat</h1></body></html>
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ brand }} – Chat</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>:root{ --accent: {{ cfg.accent or '#7aa2ff' }}; }</style>
</head>
<body>
  <div class="chat-card">
    <h1>{{ brand }}</h1>
    {% if cfg.avatar_url %}
      <div class="avatar"><img src="{{ cfg.avatar_url }}" alt="Avatar"></div>
    {% endif %}
    <p class="subtitle">{{ cfg.company or 'Assistant(e) IA' }}</p>

    <div id="chat">
      <div id="messages">
        <div class="bubble bot">{{ cfg.welcome or 'Bonjour !' }}</div>
      </div>
      <div class="row">
        <input id="msg" placeholder="Posez votre question…" />
        <button id="send">Envoyer</button>
      </div>
    </div>

    <p class="tiny">Client: {{ cfg.full_name }} — {{ cfg.email }} — ID: {{ tenant_id }}</p>
  </div>

  <script>
    const tenantId = {{ tenant_id|tojson }};
    const sendBtn  = document.getElementById('send');
    const input    = document.getElementById('msg');
    const messages = document.getElementById('messages');

    function addBubble(text, who){
      const div = document.createElement('div');
      div.className = 'bubble ' + who;
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    async function sendMessage(){
      const text = input.value.trim();
      if(!text) return;
      addBubble(text, 'user');
      input.value = '';
      try {
        const res = await fetch(`/api/chat/${tenantId}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({message:text})
        });
        const data = await res.json();
        addBubble(data.reply || '…', 'bot');
      } catch(e){
        addBubble("Désolé, une erreur réseau est survenue.", "bot");
        console.error(e);
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });
  </script>
</body>
</html>
