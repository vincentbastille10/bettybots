<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mon bot ‚Äì {{ brand }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* Mini styles pour les tiroirs (accord√©ons) */
    .accordion { display: grid; gap: 12px; }
    .acc-item { background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card); border-radius: 14px; border:1px solid rgba(255,255,255,.1); overflow: hidden; }
    .acc-head { width:100%; text-align:left; padding:14px 16px; background:transparent; color:var(--text); border:0; font-size:16px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
    .acc-body { display:none; padding:16px; border-top:1px solid rgba(255,255,255,.08); }
    .acc-item.open .acc-body { display:block; }
    .hint { color: var(--muted); font-size: 14px; }
    .row { display:grid; gap:10px; }
    .grid-2 { display:grid; grid-template-columns: 1fr; gap:18px; }
    @media (min-width: 860px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    .input, .select, .textarea { padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1426; color:var(--text); width:100%; }
    .btn { padding:12px 16px; border-radius:12px; border:1px solid rgba(122,162,255,.45); background:linear-gradient(180deg, rgba(122,162,255,.3), rgba(122,162,255,.2)); color:var(--text); cursor:pointer; text-decoration:none; display:inline-block; }
    .btn-row { display:flex; gap:10px; flex-wrap:wrap; }
    .avatar-preview { display:flex; align-items:center; gap:12px; }
    .avatar-preview img { width:56px; height:56px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,.15); }
    .code { background:#0b1020; color:#e5e7eb; padding:10px; border-radius:12px; overflow:auto; font-family: monospace; white-space: pre; }
    label { font-size:14px; color:var(--muted); display:block; margin-bottom:6px; }
  </style>
</head>
<body>
  <div class="shell">
    <header class="hero">
      <h1>Bienvenue, {{ cfg.full_name or 'Client' }}</h1>
      <p class="lead">
        <strong>√âtapes simples :</strong> (1) Choisissez le m√©tier, le caract√®re et l'avatar. (2) Cliquez "Enregistrer". (3) Copiez le <em>bloc d'int√©gration</em> √† la fin et collez-le sur votre site.
      </p>
    </header>

    <section class="grid-2">
      <!-- Colonne r√©glages (tiroirs) -->
      <div>
        <div class="accordion">

          <!-- M√©tier -->
          <div class="acc-item open" id="acc-metier">
            <button class="acc-head" type="button">
              <span>1) Choisir le <strong>m√©tier</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <p class="hint">S√©lectionnez le domaine d'activit√©. Le bot parlera avec les bons r√©flexes m√©tier.</p>
              <select id="prompt_profile" class="select">
                {% for key, text in prompts.items() %}
                  <option value="{{ key }}" {% if cfg.prompt_profile==key %}selected{% endif %}>{{ key|capitalize }}</option>
                {% endfor %}
              </select>
              <label for="prompt_custom">Ajustement (optionnel)</label>
              <textarea id="prompt_custom" class="textarea" rows="4" placeholder="Contraintes sp√©cifiques, ton, mots √† √©viter‚Ä¶">{{ cfg.prompt_custom }}</textarea>
            </div>
          </div>

          <!-- Comportement -->
          <div class="acc-item" id="acc-comportement">
            <button class="acc-head" type="button">
              <span>2) Choisir le <strong>comportement</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <p class="hint">Style de r√©ponse du bot. Vous pourrez affiner √† tout moment.</p>
              <div class="btn-row" id="tone-buttons">
                <button class="btn" data-tone="Chaleureuse et bienveillante">Chaleureuse</button>
                <button class="btn" data-tone="Professionnelle et concise">Professionnelle</button>
                <button class="btn" data-tone="Dynamique et motivante">Dynamique</button>
                <button class="btn" data-tone="Rassurante et simple">Rassurante</button>
              </div>
            </div>
          </div>

          <!-- Avatar -->
          <div class="acc-item" id="acc-avatar">
            <button class="acc-head" type="button">
              <span>3) Choisir l'<strong>avatar</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <p class="hint">Collez une adresse d'image (ex : votre logo ou photo). Un aper√ßu s'affiche.</p>
              <div class="row">
                <input id="avatar_url" class="input" value="{{ cfg.avatar_url }}" placeholder="https://‚Ä¶ (lien d'une image)"/>
                <div class="avatar-preview">
                  <img id="avatar_preview" src="{{ cfg.avatar_url or '' }}" alt="Avatar" onerror="this.style.display='none'" onload="this.style.display='block'"/>
                  <span class="hint">Aper√ßu</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Couleur -->
          <div class="acc-item" id="acc-couleur">
            <button class="acc-head" type="button">
              <span>4) Choisir la <strong>couleur</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <p class="hint">Couleur d'accent (boutons, bulles). Exemple : <code>#7aa2ff</code></p>
              <input id="accent" class="input" type="text" value="{{ cfg.accent }}" placeholder="#7aa2ff" />
            </div>
          </div>

          <!-- Message d'accueil -->
          <div class="acc-item" id="acc-welcome">
            <button class="acc-head" type="button">
              <span>5) Message d'<strong>accueil</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <input id="welcome" class="input" value="{{ cfg.welcome }}" placeholder="üëã Bonjour, je suis Betty..." />
              <p class="hint">Exemple : "üëã Bonjour, je suis Betty. Comment puis-je vous aider ?"</p>
            </div>
          </div>

          <!-- Bouton Enregistrer -->
          <div class="acc-item">
            <div class="acc-body" style="display:block; border-top:0;">
              <button id="save" class="btn" style="width:100%; justify-content:center;">Enregistrer</button>
              <p class="hint" style="margin-top:8px; text-align:center;">Pensez √† enregistrer avant de passer √† l'√©tape suivante.</p>
            </div>
          </div>

        </div>
      </div>

      <!-- Colonne int√©gration -->
      <div class="card">
        <h2>√âtape finale ‚Äî Ajouter le bot sur votre site</h2>
        <p class="hint">
          Copiez-collez le <strong>bloc ci-dessous</strong> tel quel, √† la fin de votre page (avant la fermeture).
          Vous pouvez aussi <strong>t√©l√©charger le bloc</strong> en fichier √† mettre sur votre site.
        </p>

        <!-- Bloc √† copier -->
        <pre class="code" id="embedCode">&lt;script src="{{ PUBLIC_BASE_URL }}/static/embed.js" data-tenant="{{ cfg.tenant_id }}"&gt;&lt;/script&gt;</pre>

        <div class="btn-row">
          <button id="copy" class="btn">Copier le bloc</button>
          <button id="download" class="btn">T√©l√©charger le bloc</button>
          <a class="btn" href="{{ url_for('chat_ui', tenant_id=cfg.tenant_id) }}" target="_blank">Tester mon bot</a>
        </div>

        <p class="hint" style="margin-top:10px">
          üí° Si vous ne g√©rez pas votre site, envoyez ce bloc (ou le fichier t√©l√©charg√©) √† votre webmaster :  
          "Merci d'ajouter ce bloc √† la fin de la page d'accueil."
        </p>
      </div>
    </section>
  </div>

  <script>
    const TENANT = {{ cfg.tenant_id|tojson }};
    const $ = (id) => document.getElementById(id);

    // Accord√©ons
    document.querySelectorAll('.acc-head').forEach(btn => {
      btn.addEventListener('click', () => {
        const item = btn.parentElement;
        item.classList.toggle('open');
      });
    });

    // Pr√©visualisation avatar
    const avatarInput = $('avatar_url');
    const avatarPrev = $('avatar_preview');
    
    function updatePreview() {
      const url = avatarInput.value.trim();
      if (url) {
        avatarPrev.src = url;
        avatarPrev.style.display = 'block';
      } else {
        avatarPrev.style.display = 'none';
      }
    }
    
    avatarInput.addEventListener('input', updatePreview);
    updatePreview();

    // Comportement (ton) ‚Üí on remplit prompt_custom en ajout
    document.querySelectorAll('#tone-buttons .btn').forEach(b => {
      b.addEventListener('click', () => {
        const tone = b.getAttribute('data-tone');
        const box = $('prompt_custom');
        const line = `Ton souhait√© : ${tone}.`;
        box.value = box.value.trim() ? (box.value.trim() + "\n" + line) : line;
        alert('Comportement ajout√© au r√©glage ‚úÖ');
      });
    });

    // Sauvegarde
    async function saveCfg() {
      const payload = {
        prompt_profile: $('prompt_profile').value,
        prompt_custom: $('prompt_custom').value,
        welcome: $('welcome').value,
        avatar_url: $('avatar_url').value,
        accent: $('accent').value
      };
      
      try {
        const res = await fetch(`/api/tenant/${TENANT}/update`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        alert(data && data.ok ? '‚úÖ Sauvegard√© avec succ√®s' : '‚ùå Erreur lors de la sauvegarde');
      } catch (e) {
        alert('‚ùå Erreur r√©seau : ' + e.message);
        console.error('Erreur de sauvegarde:', e);
      }
    }
    
    $('save').addEventListener('click', saveCfg);

    // Copier le bloc d'int√©gration
    $('copy').addEventListener('click', async () => {
      const text = $('embedCode').textContent;
      try {
        await navigator.clipboard.writeText(text);
        alert('‚úÖ Bloc copi√© dans le presse-papiers');
      } catch(e) {
        // Fallback pour navigateurs plus anciens
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          alert('‚úÖ Bloc copi√©');
        } catch(err) {
          alert('‚ùå Copie non autoris√©e : s√©lectionnez et copiez manuellement.');
        }
        document.body.removeChild(textarea);
      }
    });

    // T√©l√©charger le bloc d'int√©gration en fichier .html
    $('download').addEventListener('click', () => {
      const content = $('embedCode').textContent;
      const blob = new Blob([content], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'betty-integration.html';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
