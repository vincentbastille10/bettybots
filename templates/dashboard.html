<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Betty ‚Äî Configuration</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --btn:#2563eb; --pill:#1f2937; }
    * { box-sizing:border-box; font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body { margin:0; background:var(--bg); color:var(--text); }
    .wrap { max-width:980px; margin:40px auto; padding:0 16px;}
    h1 { font-size:34px; margin:0 0 8px; }
    .muted { color:var(--muted); }
    .card { background:var(--card); border:1px solid #1f2937; border-radius:14px; padding:22px; margin:18px 0; }
    .row { display:grid; grid-template-columns: 1fr 2fr; gap:16px; align-items:center; padding:10px 0; border-bottom:1px dashed #1f2937;}
    .row:last-child{ border-bottom:0; }
    select, input[type="text"], input[type="file"]{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:var(--text);
    }
    .swatches { display:flex; gap:10px; flex-wrap:wrap; }
    .swatch { width:36px; height:36px; border-radius:999px; border:2px solid #0b1220; cursor:pointer; outline:2px solid transparent; }
    .swatch.active { outline:2px solid white; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    button {
      background:var(--btn); border:none; color:white; padding:12px 16px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    button.secondary{ background:#334155; }
    code.block {
      display:block; white-space:pre-wrap; background:#0b1220; border:1px solid #1f2937; padding:16px; border-radius:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .pill { display:inline-block; padding:6px 10px; background:var(--pill); border-radius:999px; font-size:12px; color:#cbd5e1; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .hint { font-size:12px; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Bienvenue, vincent</h1>
    <p class="muted">√âtapes simples : (1) Choisissez le m√©tier, la couleur et l‚Äôavatar. (2) Cliquez ‚ÄúEnregistrer‚Äù. (3) Copiez le bloc d‚Äôint√©gration et collez-le sur votre site.</p>

    <!-- √âtape 1 : S√©lecteurs -->
    <div class="card" id="setupCard">
      <h2 style="margin:0 0 8px;">Configuration de votre bot</h2>
      <span class="pill" id="tenantPill">tenant: vincentbastile100‚Äìgmail‚Äìcom</span>

      <div class="row">
        <label for="role">M√©tier</label>
        <div>
          <select id="role">
            <option value="avocat">Avocat / Avocate</option>
            <option value="agent-immobilier">Agent Immobilier</option>
            <option value="psychologue">Psychologue</option>
            <option value="comptable">Comptable</option>
            <option value="medecin">M√©decin</option>
            <option value="danse">Danse (assistant¬∑e)</option>
          </select>
          <p class="hint">La liste peut √™tre enrichie plus tard sans changer ce tableau de bord.</p>
        </div>
      </div>

      <div class="row">
        <label>Couleur (th√®me)</label>
        <div class="swatches" id="swatches">
          <!-- couleurs ‚Äúsafe UI‚Äù -->
          <div class="swatch" data-color="#2563eb" style="background:#2563eb"></div>
          <div class="swatch" data-color="#16a34a" style="background:#16a34a"></div>
          <div class="swatch" data-color="#9333ea" style="background:#9333ea"></div>
          <div class="swatch" data-color="#ef4444" style="background:#ef4444"></div>
          <div class="swatch" data-color="#f59e0b" style="background:#f59e0b"></div>
          <div class="swatch" data-color="#0ea5e9" style="background:#0ea5e9"></div>
          <div class="swatch" data-color="#111827" style="background:#111827"></div>
          <div class="swatch" data-color="#e5e7eb" style="background:#e5e7eb"></div>
        </div>
      </div>

      <div class="row">
        <label>Avatar</label>
        <div class="grid2">
          <input type="text" id="avatarUrl" placeholder="URL de l‚Äôavatar (PNG/JPG, 512√ó512 recommand√©)" />
          <input type="file" id="avatarFile" accept="image/*" />
        </div>
        <p class="hint" style="grid-column:2;">Optionnel. Si vous chargez un fichier, il sera converti en Data URL et int√©gr√© au script d‚Äôembed.</p>
      </div>

      <div class="btns">
        <button id="saveBtn">Enregistrer</button>
        <button class="secondary" id="resetBtn">R√©initialiser</button>
      </div>
      <p class="hint" id="saveStatus"></p>
    </div>

    <!-- √âtape finale : Int√©gration -->
    <div class="card" id="finalCard" style="display:none;">
      <h2 style="margin:0 0 12px;">√âtape finale ‚Äî Ajouter le bot sur votre site</h2>
      <p>Copiez-collez le bloc ci-dessous tel quel, √† la fin de votre page (avant la fermeture <code>&lt;/body&gt;</code>).</p>

      <code class="block" id="embedBlock"></code>

      <div class="btns">
        <button id="copyBtn">Copier le bloc</button>
        <button class="secondary" id="downloadBtn">T√©l√©charger le bloc</button>
        <button class="secondary" id="testBtn">Tester mon bot</button>
      </div>
      <p class="hint">üí° Si vous ne g√©rez pas votre site, envoyez ce bloc (ou le fichier t√©l√©charg√©) √† votre webmaster.</p>
    </div>
  </div>

  <script>
    // --- Constantes ---
    const TENANT = "vincentbastile100‚Äìgmail‚Äìcom"; // garde le m√™me affichage que ton screenshot
    const TENANT_ATTR = "vincentbastile100‚Äìgmail‚Äìcom".replace(/[‚Äì]/g,'-').replace(/‚Äì/g,'-'); // fallback
    const STORAGE_KEY = "bettyConfig:" + TENANT;

    // --- Helpers ---
    const $ = (sel)=>document.querySelector(sel);
    function setActiveSwatch(hex) {
      document.querySelectorAll('.swatch').forEach(s=>{
        s.classList.toggle('active', s.dataset.color===hex);
      });
    }
    function b64Download(filename, text) {
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    }
    function toDataUrl(file) {
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // --- √âtat en m√©moire ---
    let state = {
      role: "avocat",
      color: "#2563eb",
      avatarUrl: ""
    };

    // --- Init UI ---
    (function init(){
      // Pill tenant affich√©
      $('#tenantPill').textContent = 'tenant: ' + TENANT;

      // Restaure config si dispo
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          state = JSON.parse(saved);
        } catch {}
      }
      // Applique UI
      $('#role').value = state.role || 'avocat';
      setActiveSwatch(state.color || '#2563eb');
      $('#avatarUrl').value = state.avatarUrl || '';

      // Events swatches
      document.querySelectorAll('.swatch').forEach(s=>{
        s.addEventListener('click', ()=>{
          state.color = s.dataset.color;
          setActiveSwatch(state.color);
        });
      });

      // Enregistrer
      $('#saveBtn').addEventListener('click', async ()=>{
        // Avatar file => DataURL prioritaire
        const file = $('#avatarFile').files[0];
        if (file) {
          try {
            state.avatarUrl = await toDataUrl(file);
          } catch(e) {
            console.warn('Avatar file read error', e);
          }
        } else {
          state.avatarUrl = $('#avatarUrl').value.trim();
        }
        state.role = $('#role').value;

        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        $('#saveStatus').textContent = '‚úÖ Param√®tres enregistr√©s pour ' + TENANT;

        // Construit bloc d‚Äôembed
        renderEmbed();
        // Affiche la carte finale
        $('#finalCard').style.display = 'block';
        // Scroll
        setTimeout(()=> document.getElementById('finalCard').scrollIntoView({behavior:'smooth'}), 50);
      });

      // Reset
      $('#resetBtn').addEventListener('click', ()=>{
        state = { role:'avocat', color:'#2563eb', avatarUrl:'' };
        localStorage.removeItem(STORAGE_KEY);
        $('#role').value = state.role;
        $('#avatarUrl').value = '';
        $('#avatarFile').value = '';
        setActiveSwatch(state.color);
        $('#saveStatus').textContent = 'R√©initialis√©.';
        $('#finalCard').style.display = 'none';
      });

      // Boutons int√©gration
      $('#copyBtn')?.addEventListener('click', ()=>{
        const txt = $('#embedBlock').textContent;
        navigator.clipboard.writeText(txt).then(()=>{
          alert('Bloc copi√© ‚úÖ');
        });
      });

      $('#downloadBtn')?.addEventListener('click', ()=>{
        const txt = $('#embedBlock').textContent;
        b64Download('betty-embed.html', txt);
      });

      $('#testBtn')?.addEventListener('click', ()=>{
        // Ouvre une page de test avec l‚Äôembed inject√©
        const embed = $('#embedBlock').textContent;
        const testDoc = `
<!doctype html><meta charset="utf-8">
<title>Test ‚Äî Betty</title>
<body style="font-family:system-ui; margin:40px;">
<h2>Pr√©visualisation</h2>
<p>Cette page charge le m√™me bloc d‚Äôint√©gration que vous collerez sur votre site.</p>
${embed}
</body>`;
        const blob = new Blob([testDoc], {type: 'text/html;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      });

      // Si une config existe d√©j√† => afficher directement l‚Äô√©tape finale
      if (saved) { renderEmbed(); $('#finalCard').style.display = 'block'; }
    })();

    function renderEmbed(){
      // On passe les param√®tres au script via data-* (facile c√¥t√© embed.js)
      // NOTE: garde ton URL de prod telle qu‚Äôen screenshot
      const src = "https://bettybots-flote-abonement.onrender.com/static/embed.js";
      const attrs = [
        `src="${src}"`,
        `data-tenant="${TENANT_ATTR}"`,
        `data-role="${state.role}"`,
        `data-color="${state.color}"`,
        state.avatarUrl ? `data-avatar="${state.avatarUrl}"` : null
      ].filter(Boolean).join(' ');
      const snippet = `<script ${attrs}></script>`;
      $('#embedBlock').textContent = snippet;
    }
  </script>
</body>
</html>
