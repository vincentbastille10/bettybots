<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mon bot ‚Äì {{ brand }}</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* Mini styles pour les tiroirs (accord√©ons) */
    .accordion { display: grid; gap: 12px; }
    .acc-item { background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)), var(--card); border-radius: 14px; border:1px solid rgba(255,255,255,.1); overflow: hidden; }
    .acc-head { width:100%; text-align:left; padding:14px 16px; background:transparent; color:var(--text); border:0; font-size:16px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; }
    .acc-body { display:none; padding:16px; border-top:1px solid rgba(255,255,255,.08); }
    .acc-item.open .acc-body { display:block; }
    .hint { color: var(--muted); font-size: 14px; }
    .row { display:grid; gap:10px; }
    .grid-2 { display:grid; grid-template-columns: 1fr; gap:18px; }
    @media (min-width: 860px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    .input, .select, .textarea { padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1426; color:var(--text); width:100%; }
    .btn { padding:12px 16px; border-radius:12px; border:1px solid rgba(122,162,255,.45); background:linear-gradient(180deg, rgba(122,162,255,.3), rgba(122,162,255,.2)); color:var(--text); cursor:pointer; text-decoration:none; display:inline-block; }
    .btn-row { display:flex; gap:10px; flex-wrap:wrap; }
    .avatar-preview { display:flex; align-items:center; gap:12px; }
    .avatar-preview img { width:56px; height:56px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,.15); }
    .code { background:#0b1020; color:#e5e7eb; padding:10px; border-radius:12px; overflow:auto; }
    label { font-size:14px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="shell">
    <header class="hero">
      <h1>Bienvenue, {{ cfg.full_name or 'Client' }}</h1>
      <p class="lead">
        <strong>√âtapes simples :</strong> (1) Choisissez le m√©tier, le caract√®re et l‚Äôavatar. (2) Cliquez ‚ÄúEnregistrer‚Äù. (3) Copiez le <em>bloc d‚Äôint√©gration</em> √† la fin et collez-le sur votre site.
      </p>
    </header>

    <section class="grid-2">
      <!-- Colonne r√©glages (tiroirs) -->
      <div>
        <div class="accordion">

          <!-- M√©tier -->
          <div class="acc-item open" id="acc-metier">
            <button class="acc-head" type="button">
              <span>1) Choisir le <strong>m√©tier</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <p class="hint">S√©lectionnez le domaine d‚Äôactivit√©. Le bot parlera avec les bons r√©flexes m√©tier.</p>
              <select id="prompt_profile" class="select">
                {% for key, text in prompts.items() %}
                  <option value="{{ key }}" {% if cfg.prompt_profile==key %}selected{% endif %}>{{ key|capitalize }}</option>
                {% endfor %}
              </select>
              <label for="prompt_custom">Ajustement (optionnel)</label>
              <textarea id="prompt_custom" class="textarea" rows="4" placeholder="Contraintes sp√©cifiques, ton, mots √† √©viter‚Ä¶">{{ cfg.prompt_custom }}</textarea>
            </div>
          </div>

          <!-- Comportement -->
          <div class="acc-item" id="acc-comportement">
            <button class="acc-head" type="button">
              <span>2) Choisir le <strong>comportement</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <p class="hint">Style de r√©ponse du bot. Vous pourrez affiner √† tout moment.</p>
              <div class="btn-row" id="tone-buttons">
                <button class="btn" data-tone="Chaleureuse et bienveillante">Chaleureuse</button>
                <button class="btn" data-tone="Professionnelle et concise">Professionnelle</button>
                <button class="btn" data-tone="Dynamique et motivante">Dynamique</button>
                <button class="btn" data-tone="Rassurante et simple">Rassurante</button>
              </div>
            </div>
          </div>

          <!-- Avatar -->
          <div class="acc-item" id="acc-avatar">
            <button class="acc-head" type="button">
              <span>3) Choisir l‚Äô<strong>avatar</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <p class="hint">Collez une adresse d‚Äôimage (ex : votre logo ou photo). Un aper√ßu s‚Äôaffiche.</p>
              <div class="row">
                <input id="avatar_url" class="input" value="{{ cfg.avatar_url }}" placeholder="https://‚Ä¶ (lien d‚Äôune image)"/>
                <div class="avatar-preview">
                  <img id="avatar_preview" src="{{ cfg.avatar_url or '' }}" alt="Avatar"/>
                  <span class="hint">Aper√ßu</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Couleur -->
          <div class="acc-item" id="acc-couleur">
            <button class="acc-head" type="button">
              <span>4) Choisir la <strong>couleur</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <p class="hint">Couleur d‚Äôaccent (boutons, bulles). Exemple : <code>#7aa2ff</code></p>
              <input id="accent" class="input" value="{{ cfg.accent }}" />
            </div>
          </div>

          <!-- Message d‚Äôaccueil -->
          <div class="acc-item" id="acc-welcome">
            <button class="acc-head" type="button">
              <span>5) Message d‚Äô<strong>accueil</strong></span><span>‚ñæ</span>
            </button>
            <div class="acc-body">
              <input id="welcome" class="input" value="{{ cfg.welcome }}" />
              <p class="hint">Exemple : ‚Äúüëã Bonjour, je suis Betty. Comment puis-je vous aider ?‚Äù</p>
            </div>
          </div>

          <!-- Bouton Enregistrer -->
          <div class="acc-item">
            <div class="acc-body" style="display:block">
              <button id="save" class="btn">Enregistrer</button>
              <span class="hint">Pensez √† enregistrer avant de passer √† l‚Äô√©tape suivante.</span>
            </div>
          </div>

        </div>
      </div>

      <!-- Colonne int√©gration (sans parler de ‚Äúscript‚Äù) -->
      <div class="card">
        <h2>√âtape finale ‚Äî Ajouter le bot sur votre site</h2>
        <p class="hint">
          Copiez-collez le <strong>bloc ci-dessous</strong> tel quel, √† la fin de votre page (avant la fermeture).
          Vous pouvez aussi <strong>t√©l√©charger le bloc</strong> en fichier √† mettre sur votre site.
        </p>

        <!-- Bloc √† copier (on √©vite le mot 'script' dans le texte, mais le code est celui requis) -->
        <pre class="code" id="embedCode"><code>
&lt;script src="{{ PUBLIC_BASE_URL }}/static/embed.js" data-tenant="{{ cfg.tenant_id }}"&gt;&lt;/script&gt;
</code></pre>

        <div class="btn-row">
          <button id="copy" class="btn">Copier le bloc</button>
          <button id="download" class="btn">T√©l√©charger le bloc</button>
          <a class="btn" href="{{ url_for('chat_ui', tenant_id=cfg.tenant_id) }}" target="_blank">Tester mon bot</a>
        </div>

        <p class="hint" style="margin-top:10px">
          üí° Si vous ne g√©rez pas votre site, envoyez ce bloc (ou le fichier t√©l√©charg√©) √† votre webmaster :  
          ‚ÄúMerci d‚Äôajouter ce bloc √† la fin de la page d‚Äôaccueil.‚Äù
        </p>
      </div>
    </section>
  </div>

  <script>
    const TENANT = {{ cfg.tenant_id|tojson }};
    const $ = (id) => document.getElementById(id);

    // Accord√©ons
    document.querySelectorAll('.acc-head').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const item = btn.parentElement;
        item.classList.toggle('open');
      });
    });

    // Pr√©visualisation avatar
    const avatarInput = $('avatar_url');
    const avatarPrev  = $('avatar_preview');
    function updatePreview(){ avatarPrev.src = avatarInput.value || ''; }
    avatarInput.addEventListener('input', updatePreview);
    updatePreview();

    // Comportement (ton) ‚Üí on remplit prompt_custom en ajout
    document.querySelectorAll('#tone-buttons .btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const tone = b.getAttribute('data-tone');
        const box  = $('prompt_custom');
        const line = `Ton souhait√© : ${tone}.`;
        box.value = box.value ? (box.value.trim() + "\\n" + line) : line;
        alert('Comportement ajout√© au r√©glage ‚úÖ');
      });
    });

    // Sauvegarde
    async function saveCfg() {
      const payload = {
        prompt_profile: $('prompt_profile').value,
        prompt_custom:  $('prompt_custom').value,
        welcome:        $('welcome').value,
        avatar_url:     $('avatar_url').value,
        accent:         $('accent').value
      };
      try {
        const res = await fetch(`/api/tenant/${TENANT}/update`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        alert(data && data.ok ? '‚úÖ Sauvegard√©' : '‚ùå Erreur lors de la sauvegarde');
      } catch (e) {
        alert('‚ùå Erreur r√©seau');
        console.error(e);
      }
    }
    $('save').addEventListener('click', saveCfg);

    // Copier le bloc d‚Äôint√©gration
    $('copy').addEventListener('click', async ()=>{
      const text = document.getElementById('embedCode').innerText;
      try { await navigator.clipboard.writeText(text); alert('Bloc copi√© ‚úÖ'); }
      catch(e){ alert('Copie non autoris√©e : s√©lectionnez et copiez manuellement.'); }
    });

    // T√©l√©charger le bloc d‚Äôint√©gration en fichier .html
    $('download').addEventListener('click', ()=>{
      const content = document.getElementById('embedCode').innerText;
      const blob = new Blob([content], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'betty-integration.html';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
